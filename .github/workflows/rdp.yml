name: Ubuntu VNC (ngrok - hardcoded)

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install Desktop Environment & VNC
        run: |
          sudo apt update
          sudo apt install xfce4 xfce4-goodies tightvncserver git wget unzip jq -y
          
          # Variables en clair (⚠️ pas sécurisé)
          VNC_PASSWORD="WailZaz1980"         # max 8 caractères
          NGROK_AUTH="32jEpd21ZqJpzN5xDGzzeFYkWZS_3858fFtyY71BayjFdiAkp"  # ton token ngrok

          # Préparer VNC
          mkdir -p ~/.vnc
          echo "$VNC_PASSWORD" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

          # Configurer xstartup
          echo "#!/bin/bash
          xrdb $HOME/.Xresources
          startxfce4 &" > ~/.vnc/xstartup
          chmod +x ~/.vnc/xstartup

          # Lancer serveur VNC
          vncserver :1 -geometry 1280x720 -depth 24

          # Installer noVNC
          git clone https://github.com/novnc/noVNC.git ~/noVNC
          git clone https://github.com/novnc/websockify ~/noVNC/utils/websockify
          nohup ~/noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 6080 &

          # Installer ngrok
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          ./ngrok config add-authtoken $NGROK_AUTH
          nohup ./ngrok http 6080 > ngrok.log &
          sleep 10

          # Afficher l'URL publique ngrok
          echo "------ NGROK PUBLIC URL ------"
          curl --silent http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url'
